let axios = require('axios').default;
let moment = require('moment-timezone');

let createWagon = (w, group) => ({
    group,
    type: w.kategorie,
    id: w.fahrzeugnummer,
    wagonNumber: +w.wagenordnungsnummer || null,
    fahrzeugsektor: w.fahrzeugsektor,
    status: w.status
    // todo: other attributes
});

// todo: validate params

export async function wagenreihung (trainNumber, lastDeparture) {
    let date = moment.tz(lastDeparture, 'Europe/Berlin').format('YYYYMMDDHHmm');
    let catchError = false;
    let data = await axios.get(`https://www.apps-bahn.de/wr/wagenreihung/1.0/${trainNumber}/${date}`).catch(() => catchError = true).then(res => res.data);
    //let data = {"meta":{"id":"7641BF1F22C24FC8AFDF58EB936ADC19","owner":"vz","format":"JSON","version":"0.2.69","correlation":[],"created":"2020-01-03T17:58:08.608+01:00","sequence":97},"data":{"istformation":{"fahrtrichtung":"VORWAERTS","allFahrzeuggruppe":[{"allFahrzeug":[{"allFahrzeugausstattung":[{"anzahl":"","ausstattungsart":"KLIMA","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"RUHE","bezeichnung":"","status":"UNDEFINIERT"}],"kategorie":"STEUERWAGENZWEITEKLASSE","fahrzeugnummer":"938054115663","orientierung":"UNDEFINIERT","positioningruppe":"1","fahrzeugsektor":"A","fahrzeugtyp":"Bpmzf","wagenordnungsnummer":"31","positionamhalt":{"endemeter":"425.2","endeprozent":"99","startmeter":"398.2","startprozent":"93"},"status":"OFFEN"},{"allFahrzeugausstattung":[{"anzahl":"","ausstattungsart":"KLIMA","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"RUHE","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"PLAETZEROLLSTUHL","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"ROLLSTUHLTOILETTE","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"PLAETZESCHWERBEH","bezeichnung":"","status":"UNDEFINIERT"}],"kategorie":"REISEZUGWAGENZWEITEKLASSE","fahrzeugnummer":"938054116661","orientierung":"UNDEFINIERT","positioningruppe":"2","fahrzeugsektor":"A","fahrzeugtyp":"Bpmbz","wagenordnungsnummer":"32","positionamhalt":{"endemeter":"398.2","endeprozent":"93","startmeter":"372.3","startprozent":"87"},"status":"OFFEN"},{"allFahrzeugausstattung":[{"anzahl":"","ausstattungsart":"KLIMA","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"INFO","bezeichnung":"","status":"UNDEFINIERT"}],"kategorie":"REISEZUGWAGENZWEITEKLASSE","fahrzeugnummer":"938054117669","orientierung":"UNDEFINIERT","positioningruppe":"3","fahrzeugsektor":"A","fahrzeugtyp":"Bpmz","wagenordnungsnummer":"33","positionamhalt":{"endemeter":"372.3","endeprozent":"87","startmeter":"346.4","startprozent":"81"},"status":"OFFEN"},{"allFahrzeugausstattung":[{"anzahl":"","ausstattungsart":"KLIMA","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"FAMILIE","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"3","ausstattungsart":"PLAETZEFAHRRAD","bezeichnung":"","status":"UNDEFINIERT"}],"kategorie":"REISEZUGWAGENZWEITEKLASSE","fahrzeugnummer":"938054118667","orientierung":"UNDEFINIERT","positioningruppe":"4","fahrzeugsektor":"B","fahrzeugtyp":"Bpmdz","wagenordnungsnummer":"34","positionamhalt":{"endemeter":"346.4","endeprozent":"81","startmeter":"320.5","startprozent":"74"},"status":"OFFEN"},{"allFahrzeugausstattung":[{"anzahl":"","ausstattungsart":"ABTEILKLEINKIND","bezeichnung":"","status":"UNDEFINIERT"}],"kategorie":"SPEISEWAGEN","fahrzeugnummer":"938054112660","orientierung":"UNDEFINIERT","positioningruppe":"5","fahrzeugsektor":"B","fahrzeugtyp":"WRmz","wagenordnungsnummer":"36","positionamhalt":{"endemeter":"320.5","endeprozent":"74","startmeter":"294.6","startprozent":"68"},"status":"OFFEN"},{"allFahrzeugausstattung":[{"anzahl":"","ausstattungsart":"KLIMA","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"PLAETZEBAHNCOMFORT","bezeichnung":"","status":"UNDEFINIERT"}],"kategorie":"REISEZUGWAGENERSTEZWEITEKLASSE","fahrzeugnummer":"938054111662","orientierung":"UNDEFINIERT","positioningruppe":"6","fahrzeugsektor":"C","fahrzeugtyp":"ABpmz","wagenordnungsnummer":"37","positionamhalt":{"endemeter":"294.6","endeprozent":"68","startmeter":"268.7","startprozent":"62"},"status":"OFFEN"},{"allFahrzeugausstattung":[{"anzahl":"","ausstattungsart":"KLIMA","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"RUHE","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"PLAETZEBAHNCOMFORT","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"PLAETZESCHWERBEH","bezeichnung":"","status":"UNDEFINIERT"}],"kategorie":"STEUERWAGENERSTEKLASSE","fahrzeugnummer":"938054110664","orientierung":"UNDEFINIERT","positioningruppe":"7","fahrzeugsektor":"C","fahrzeugtyp":"Apmzf","wagenordnungsnummer":"38","positionamhalt":{"endemeter":"268.7","endeprozent":"62","startmeter":"240.8","startprozent":"56"},"status":"OFFEN"}],"fahrzeuggruppebezeichnung":"ICE1166","zielbetriebsstellename":"Leipzig Hbf","startbetriebsstellename":"Hamburg-Altona","verkehrlichezugnummer":"1607"},{"allFahrzeug":[{"allFahrzeugausstattung":[{"anzahl":"","ausstattungsart":"KLIMA","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"RUHE","bezeichnung":"","status":"UNDEFINIERT"}],"kategorie":"STEUERWAGENZWEITEKLASSE","fahrzeugnummer":"938054115671","orientierung":"UNDEFINIERT","positioningruppe":"1","fahrzeugsektor":"D","fahrzeugtyp":"Bpmzf","wagenordnungsnummer":"21","positionamhalt":{"endemeter":"240.8","endeprozent":"56","startmeter":"213.8","startprozent":"50"},"status":"OFFEN"},{"allFahrzeugausstattung":[{"anzahl":"","ausstattungsart":"KLIMA","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"RUHE","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"PLAETZEROLLSTUHL","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"ROLLSTUHLTOILETTE","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"PLAETZESCHWERBEH","bezeichnung":"","status":"UNDEFINIERT"}],"kategorie":"REISEZUGWAGENZWEITEKLASSE","fahrzeugnummer":"938054116679","orientierung":"UNDEFINIERT","positioningruppe":"2","fahrzeugsektor":"D","fahrzeugtyp":"Bpmbz","wagenordnungsnummer":"22","positionamhalt":{"endemeter":"213.8","endeprozent":"50","startmeter":"187.9","startprozent":"44"},"status":"OFFEN"},{"allFahrzeugausstattung":[{"anzahl":"","ausstattungsart":"KLIMA","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"INFO","bezeichnung":"","status":"UNDEFINIERT"}],"kategorie":"REISEZUGWAGENZWEITEKLASSE","fahrzeugnummer":"938054117677","orientierung":"UNDEFINIERT","positioningruppe":"3","fahrzeugsektor":"E","fahrzeugtyp":"Bpmz","wagenordnungsnummer":"23","positionamhalt":{"endemeter":"187.9","endeprozent":"44","startmeter":"162","startprozent":"38"},"status":"OFFEN"},{"allFahrzeugausstattung":[{"anzahl":"","ausstattungsart":"KLIMA","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"FAMILIE","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"3","ausstattungsart":"PLAETZEFAHRRAD","bezeichnung":"","status":"UNDEFINIERT"}],"kategorie":"REISEZUGWAGENZWEITEKLASSE","fahrzeugnummer":"938054118675","orientierung":"UNDEFINIERT","positioningruppe":"4","fahrzeugsektor":"E","fahrzeugtyp":"Bpmdz","wagenordnungsnummer":"24","positionamhalt":{"endemeter":"162","endeprozent":"38","startmeter":"136.1","startprozent":"32"},"status":"OFFEN"},{"allFahrzeugausstattung":[{"anzahl":"","ausstattungsart":"ABTEILKLEINKIND","bezeichnung":"","status":"UNDEFINIERT"}],"kategorie":"SPEISEWAGEN","fahrzeugnummer":"938054112678","orientierung":"UNDEFINIERT","positioningruppe":"5","fahrzeugsektor":"F","fahrzeugtyp":"WRmz","wagenordnungsnummer":"26","positionamhalt":{"endemeter":"136.1","endeprozent":"32","startmeter":"110.2","startprozent":"26"},"status":"OFFEN"},{"allFahrzeugausstattung":[{"anzahl":"","ausstattungsart":"KLIMA","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"PLAETZEBAHNCOMFORT","bezeichnung":"","status":"UNDEFINIERT"}],"kategorie":"REISEZUGWAGENERSTEZWEITEKLASSE","fahrzeugnummer":"938054111670","orientierung":"UNDEFINIERT","positioningruppe":"6","fahrzeugsektor":"G","fahrzeugtyp":"ABpmz","wagenordnungsnummer":"27","positionamhalt":{"endemeter":"110.2","endeprozent":"26","startmeter":"84.3","startprozent":"20"},"status":"OFFEN"},{"allFahrzeugausstattung":[{"anzahl":"","ausstattungsart":"KLIMA","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"RUHE","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"PLAETZEBAHNCOMFORT","bezeichnung":"","status":"UNDEFINIERT"},{"anzahl":"","ausstattungsart":"PLAETZESCHWERBEH","bezeichnung":"","status":"UNDEFINIERT"}],"kategorie":"STEUERWAGENERSTEKLASSE","fahrzeugnummer":"938054110672","orientierung":"UNDEFINIERT","positioningruppe":"7","fahrzeugsektor":"G","fahrzeugtyp":"Apmzf","wagenordnungsnummer":"28","positionamhalt":{"endemeter":"84.3","endeprozent":"20","startmeter":"56.4","startprozent":"13"},"status":"OFFEN"}],"fahrzeuggruppebezeichnung":"ICE1167","zielbetriebsstellename":"MÃ¼nchen Hbf","startbetriebsstellename":"Hamburg-Altona","verkehrlichezugnummer":"1607"}],"halt":{"abfahrtszeit":"2020-01-03T20:30:00","ankunftszeit":"2020-01-03T20:20:00","bahnhofsname":"Berlin Hbf (tief)","evanummer":"8098160","gleisbezeichnung":"1","haltid":"BL","rl100":"BL","allSektor":[{"positionamgleis":{"endemeter":"97.55","endeprozent":"23","startmeter":"0","startprozent":"0"},"sektorbezeichnung":"G"},{"positionamgleis":{"endemeter":"145.45","endeprozent":"34","startmeter":"97.55","startprozent":"23"},"sektorbezeichnung":"F"},{"positionamgleis":{"endemeter":"197.725","endeprozent":"46","startmeter":"145.45","startprozent":"34"},"sektorbezeichnung":"E"},{"positionamgleis":{"endemeter":"249.975","endeprozent":"58","startmeter":"197.725","startprozent":"46"},"sektorbezeichnung":"D"},{"positionamgleis":{"endemeter":"302.25","endeprozent":"70","startmeter":"249.975","startprozent":"58"},"sektorbezeichnung":"C"},{"positionamgleis":{"endemeter":"354.525","endeprozent":"82","startmeter":"302.25","startprozent":"70"},"sektorbezeichnung":"B"},{"positionamgleis":{"endemeter":"430.3","endeprozent":"100","startmeter":"354.525","startprozent":"82"},"sektorbezeichnung":"A"}]},"liniebezeichnung":"28","zuggattung":"ICE","zugnummer":"1607","serviceid":"6902976268","planstarttag":"2020-01-03","fahrtid":"","istplaninformation":false}}}

    if (catchError) {
        return "error";
    }

    let d = data.data.istformation;

    let wagons = [];
    for (const i in d.allFahrzeuggruppe) {
        for (const w of d.allFahrzeuggruppe[i].allFahrzeug) {
            wagons.push(createWagon(w, +i))
        }
    }

    //console.log("FOUND WAGENREIHUNG: ", `https://www.apps-bahn.de/wr/wagenreihung/1.0/${trainNumber}/${date}`);

    return ({
        initializationDate: data.meta.created,
        product: d.zuggattung,
        trainNumber: d.zugnummer,
        serviceId: d.serviceid,
        wagons
    })
}